<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Ref Navigator - Ultra-Fast Mode</title>
  <style>
    :root { --bg: #000; --ui-bg: rgba(25,25,25,0.9); --accent: #4a90e2; }
    body { margin: 0; background: var(--bg); color: #fff; font-family: system-ui, sans-serif; height: 100vh; overflow: hidden; user-select: none; }
    
    .viewport { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; touch-action: none; z-index: 1; }
    #mainImage { width: 100%; height: 100%; object-fit: contain; will-change: transform; transition: opacity 0.2s; cursor: grab; }
    #mainImage:active { cursor: grabbing; }

    .ui-layer { position: fixed; z-index: 100; display: flex; pointer-events: none; transition: opacity 0.3s; }
    .ui-layer > * { pointer-events: auto; }

    .top-bar { top: 15px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; gap: 10px; }
    .category-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; background: var(--ui-bg); padding: 6px; border-radius: 12px; border: 1px solid #333; }
    
    .cat-btn { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; background: #333; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; color: #888; }
    .cat-btn input { display: none; }
    .cat-btn:has(input:checked) { background: var(--accent); color: #fff; box-shadow: 0 0 10px rgba(74,144,226,0.3); }

    .nav-layer { inset: 0; justify-content: space-between; align-items: center; padding: 0 20px; }
    .nav-btn { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 30px; padding: 25px 15px; border-radius: 10px; cursor: pointer; backdrop-filter: blur(2px); }
    .nav-btn:disabled { opacity: 0.1; }

    .bottom-bar { bottom: 20px; left: 50%; transform: translateX(-50%); gap: 20px; background: var(--ui-bg); padding: 10px 25px; border-radius: 30px; border: 1px solid #333; }
    .tool-btn { background: none; border: none; color: #aaa; font-size: 20px; cursor: pointer; transition: color 0.2s; }
    .tool-btn:hover { color: #fff; }

    #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--ui-bg); padding: 15px 30px; border-radius: 15px; border: 1px solid var(--accent); display: none; z-index: 1000; }
    .hidden-ui { opacity: 0; pointer-events: none !important; }
  </style>
</head>
<body>

<div class="ui-layer top-bar" id="ui-top">
  <div id="catWrapper" class="category-container"></div>
</div>

<div class="viewport">
  <img id="mainImage" draggable="false" />
</div>

<div id="loader">SNIPING LINK...</div>

<div class="ui-layer nav-layer" id="ui-nav">
  <button id="backBtn" class="nav-btn">‚ùÆ</button>
  <button id="fwdBtn" class="nav-btn">‚ùØ</button>
</div>

<div class="ui-layer bottom-bar" id="ui-bottom">
  <button id="resetBtn" class="tool-btn">‚Üª</button>
  <button id="flipBtn" class="tool-btn">‚Üî</button>
  <button id="copyBtn" class="tool-btn">üìã</button>
  <button id="uiBtn" class="tool-btn">üëÅ</button>
</div>

<script>
  const baseURL = 'https://f003.backblazeb2.com/file/linksref2/';
  const categories = [
    {v:"People",l:"P"},{v:"pplus",l:"p"},{v:"Anime",l:"A"},{v:"angle",l:"a"},{v:"Figure",l:"F"},{v:"Style",l:"S"},
    {v:"XMaleAnatomy",l:"X"},{v:"Emotions",l:"E"},{v:"Background",l:"B"},{v:"Walk",l:"W"},{v:"screencap",l:"s"},{v:"Manga",l:"M"},
    {v:"moeManga",l:"m"},{v:"TestPanel",l:"T"}
  ];

  const state = {
    fileSizes: {},      // Cache for Range logic
    backStack: [],      // Max 5
    forwardStack: [],   // Max 5
    currentUrl: null,
    transform: { x:0, y:0, scale:1, flipped:false },
    isDragging: false,
    dragStart: { x:0, y:0 }
  };

  const el = {
    img: document.getElementById('mainImage'),
    cats: document.getElementById('catWrapper'),
    loader: document.getElementById('loader'),
    btnBack: document.getElementById('backBtn'),
    btnFwd: document.getElementById('fwdBtn')
  };

  function init() {
    categories.forEach(cat => {
      const label = document.createElement('label');
      label.className = 'cat-btn';
      label.innerHTML = `<input type="checkbox" value="${cat.v}">${cat.l}`;
      el.cats.appendChild(label);
    });
    el.cats.querySelector('input').checked = true;
    
    bindControls();
    navigateForward(true);
  }

  // Gets file size without downloading content
  async function getFileSize(cat) {
    if (state.fileSizes[cat]) return state.fileSizes[cat];
    const resp = await fetch(baseURL + cat + '.txt', { method: 'HEAD' });
    const size = parseInt(resp.headers.get('content-length'));
    state.fileSizes[cat] = size;
    return size;
  }

  // The "Sniper" - Grabs a random URL from a file of any size
  async function sniperFetch() {
    const active = [...el.cats.querySelectorAll('input:checked')].map(i => i.value);
    if (!active.length) return null;
    
    // Pick Category first (Equal chance)
    const cat = active[Math.floor(Math.random() * active.length)];
    const totalSize = await getFileSize(cat);
    
    // Jump to random byte
    const randomPos = Math.floor(Math.random() * (totalSize - 3000));
    
    try {
      const resp = await fetch(baseURL + cat + '.txt', {
        headers: { 'Range': `bytes=${randomPos}-${randomPos + 2500}` }
      });
      const chunk = await resp.text();
      const lines = chunk.split('\n');
      // Discard first and last lines as they are likely partials
      const validLines = lines.slice(1, -1).filter(l => l.length > 10);
      return validLines[Math.floor(Math.random() * validLines.length)].trim();
    } catch (e) {
      console.error("Snipe failed", e);
      return null;
    }
  }

  async function navigateForward(forceNew = false) {
    if (!forceNew && state.forwardStack.length > 0) {
      if (state.currentUrl) pushToStack(state.backStack, state.currentUrl);
      displayImage(state.forwardStack.shift());
    } else {
      el.loader.style.display = 'block';
      const next = await sniperFetch();
      if (next) {
        if (state.currentUrl) pushToStack(state.backStack, state.currentUrl);
        displayImage(next);
      }
    }
  }

  function navigateBack() {
    if (!state.backStack.length) return;
    if (state.currentUrl) pushToStack(state.forwardStack, state.currentUrl);
    displayImage(state.backStack.pop());
  }

  function pushToStack(stack, url) {
    stack.push(url);
    if (stack.length > 5) stack.shift();
    updateButtons();
  }

  function displayImage(url) {
    state.currentUrl = url;
    el.img.style.opacity = '0.2';
    const temp = new Image();
    temp.onload = () => {
      el.img.src = url;
      el.img.style.opacity = '1';
      el.loader.style.display = 'none';
      resetTransform();
      updateButtons();
    };
    temp.onerror = () => navigateForward(true);
    temp.src = url;
  }

  function updateButtons() {
    el.btnBack.disabled = state.backStack.length === 0;
  }

  // Transforms
  function applyTransform() {
    const {x, y, scale, flipped} = state.transform;
    el.img.style.transform = `translate(${x}px, ${y}px) scale(${scale * (flipped ? -1 : 1)}, ${scale})`;
  }

  function resetTransform() {
    state.transform = { x:0, y:0, scale:1, flipped:false };
    applyTransform();
  }

  function bindControls() {
    el.btnFwd.onclick = () => navigateForward();
    el.btnBack.onclick = navigateBack;
    document.getElementById('resetBtn').onclick = resetTransform;
    document.getElementById('flipBtn').onclick = () => { state.transform.flipped = !state.transform.flipped; applyTransform(); };
    document.getElementById('uiBtn').onclick = () => {
      document.getElementById('ui-top').classList.toggle('hidden-ui');
      document.getElementById('ui-nav').classList.toggle('hidden-ui');
      document.getElementById('ui-bottom').classList.toggle('hidden-ui');
    };
    document.getElementById('copyBtn').onclick = () => { if(state.currentUrl) navigator.clipboard.writeText(state.currentUrl); };

    // Keys: W(zoom in), S(zoom out), A(back), D(fwd), U(UI)
    document.onkeydown = (e) => {
      const k = e.key.toLowerCase();
      if (k === 'd') navigateForward();
      if (k === 'a') navigateBack();
      if (k === 'w') { state.transform.scale += 0.15; applyTransform(); }
      if (k === 's') { state.transform.scale = Math.max(0.1, state.transform.scale - 0.15); applyTransform(); }
      if (k === 'u') document.getElementById('uiBtn').click();
      if (k === 'f') document.getElementById('flipBtn').click();
      if (k === 'r') resetTransform();
    };

    // Dragging
    const start = (x, y) => { state.isDragging = true; state.dragStart = { x: x - state.transform.x, y: y - state.transform.y }; };
    const move = (x, y) => { if (state.isDragging) { state.transform.x = x - state.dragStart.x; state.transform.y = y - state.dragStart.y; applyTransform(); } };
    el.img.onmousedown = e => start(e.clientX, e.clientY);
    window.onmousemove = e => move(e.clientX, e.clientY);
    window.onmouseup = () => state.isDragging = false;
    el.img.ontouchstart = e => start(e.touches[0].clientX, e.touches[0].clientY);
    window.ontouchmove = e => move(e.touches[0].clientX, e.touches[0].clientY);
    window.ontouchend = () => state.isDragging = false;
  }

  init();
</script>
</body>
</html>
