<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ultra Fast Preload Image Navigator</title>
<style>
*{box-sizing:border-box;}

body {margin:0;background:#000;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;height:100vh;overflow:hidden;}
#topControls {position:fixed;top:5px;z-index:1000;display:flex;gap:10px;background:rgba(0,0,0,0.5);padding:5px 10px;border-radius:8px;}
body.hide-ui #topControls, body.hide-ui .toggles, body.hide-ui .search-bar, body.hide-ui .controls {display:none;}
#instancesContainer {margin-top:50px;width:100%;height:100%;display:flex;flex-direction:column;gap:5px;}
.row{display:flex;width:100%;gap:5px;flex:1;}

.instance{position:relative;width:100%;flex:1;display:flex;flex-direction:column;min-height:0;}
.image-wrapper{flex:1;position:relative;overflow:hidden;}
.instance img{width:100%;height:100%;object-fit:contain;border:2px solid #fff;border-radius:6px;}

.nav-arrow{position:absolute;top:50%;transform:translateY(-50%);font-size:48px;color:white;opacity:0.5;cursor:pointer;z-index:20;}
.nav-arrow.left{left:10px;} .nav-arrow.right{right:10px;}

.toggles,.search-bar,.controls{position:absolute;z-index:10;background:rgba(0,0,0,0.5);padding:3px 5px;border-radius:4px;display:flex;gap:4px;flex-wrap:wrap;}
.toggles{top:5px;left:50%;transform:translateX(-50%);}
.search-bar{top:5px;left:5px;}
.controls{bottom:5px;left:50%;transform:translateX(-50%);}
</style>
</head>
<body>

<div id="topControls">
<label>Instances:
  <select id="instanceCount">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
  </select>
</label>
<label><input type="checkbox" id="layoutToggle"> Custom Layout</label>
<button id="hideUIBtn">Hide UI</button>
</div>

<div id="instancesContainer"></div>

<script>
const baseURL='https://f003.backblazeb2.com/file/linksref2/';
const IMAGE_EXT=/\.(jpg|jpeg|png|webp|gif|avif|bmp)$/i;
let instances=[];

const categories=[
  {v:"People",l:"P"},{v:"pplus",l:"p"},{v:"Anime",l:"A"},{v:"angle",l:"a"},
  {v:"Figure",l:"F"},{v:"Style",l:"S"},{v:"XMaleAnatomy",l:"X"},
  {v:"Emotions",l:"E"},{v:"Background",l:"B"},{v:"Walk",l:"W"},
  {v:"screencap",l:"s"},{v:"Manga",l:"M"},{v:"moeManga",l:"m"},
  {v:"TestPanel",l:"T"}
];

class ImageInstance{
  constructor(){
    this.history=[]; this.future=[];
    this.sourceLists={};
    this.preloadImages=[];
    this.loadToken=0;
    this.createUI();
  }

  createUI(){
    this.el=document.createElement('div');
    this.el.className='instance';
    this.el.innerHTML=`
      <div class="search-bar"><input placeholder="Search (#tag)"></div>
      <div class="toggles">${categories.map(c=>`<label><input type="checkbox" value="${c.v}">${c.l}</label>`).join('')}</div>
      <div class="image-wrapper">
        <div class="nav-arrow left">&#10094;</div>
        <div class="nav-arrow right">&#10095;</div>
        <img draggable="false">
      </div>
      <div class="controls"><button class="resetBtn">Reset</button></div>`;
    this.img=this.el.querySelector('img');
    this.el.querySelector('.left').onclick=()=>this.back();
    this.el.querySelector('.right').onclick=()=>this.forward();
    this.el.querySelectorAll('input[type=checkbox]').forEach(c=>c.onchange=()=>this.reloadSources());
  }

  async fetchLinks(subject){
    try{
      const r=await fetch(`${baseURL}${subject}.txt`);
      return (await r.text()).split('\n').map(l=>l.trim()).filter(l=>IMAGE_EXT.test(l));
    }catch{return []}
  }

  async reloadSources(){
    const token=++this.loadToken;
    const sel=[...this.el.querySelectorAll('input[type=checkbox]')].filter(c=>c.checked).map(c=>c.value);
    this.history=[]; this.future=[]; this.preloadImages=[]; this.sourceLists={}; this.img.src='';
    if(!sel.length) return;
    const res=await Promise.all(sel.map(s=>this.fetchLinks(s)));
    if(token!==this.loadToken) return;
    this.sourceLists=Object.fromEntries(sel.map((s,i)=>[s,res[i]]));
    const first=await this.randomImage();
    if(first && token===this.loadToken){ this.show(first); this.preloadNext(); }
  }

  async loadValidImage(url){
    return new Promise(resolve=>{
      const img=new Image();
      img.src=url;
      img.onload=()=>resolve(img.naturalWidth>=150 && img.naturalHeight>=150 ? url : null);
      img.onerror=()=>resolve(null);
    });
  }

  async randomImage(){
    const keys=Object.keys(this.sourceLists);
    for(let i=0;i<20;i++){
      const k=keys[Math.random()*keys.length|0];
      const list=this.sourceLists[k];
      if(!list?.length) continue;
      const ok=await this.loadValidImage(list[Math.random()*list.length|0]);
      if(ok) return ok;
    }
    return null;
  }

  async preloadNext(n=5){
    for(let i=0;i<n;i++){
      this.randomImage().then(u=>{
        if(u) this.preloadImages.push(u);
        if(this.preloadImages.length>n) this.preloadImages.shift();
      });
    }
  }

  async forward(){
    if(this.preloadImages.length){
      this.history.push(this.img.src);
      this.show(this.preloadImages.shift());
      this.preloadNext();
    }
  }

  back(){
    if(!this.history.length) return;
    this.show(this.history.pop());
  }

  show(url){ this.img.src=url; }
}

/* ðŸ”§ CUSTOM LAYOUT LOGIC â€” ONLY NEW PART */
function applyLayout(){
  const c=document.getElementById('instancesContainer');
  const count=instances.length;
  const custom=document.getElementById('layoutToggle').checked;
  c.innerHTML='';

  if(!custom || count===1){
    instances.forEach(i=>c.appendChild(i.el));
    return;
  }

  if(count===2){
    const top=document.createElement('div'); top.className='row'; top.style.flex='0.66';
    const bottom=document.createElement('div'); bottom.className='row'; bottom.style.flex='0.34';
    top.appendChild(instances[0].el);
    bottom.appendChild(instances[1].el);
    c.append(top,bottom);
  }

  if(count===3){
    const top=document.createElement('div'); top.className='row'; top.style.flex='0.66';
    const bottom=document.createElement('div'); bottom.className='row'; bottom.style.flex='0.34';
    top.appendChild(instances[0].el);
    bottom.appendChild(instances[1].el);
    bottom.appendChild(instances[2].el);
    c.append(top,bottom);
  }
}

function createInstances(n){
  instances=[];
  for(let i=0;i<n;i++) instances.push(new ImageInstance());
  applyLayout();
}

document.getElementById('instanceCount').onchange=e=>createInstances(+e.target.value);
document.getElementById('layoutToggle').onchange=applyLayout;
document.getElementById('hideUIBtn').onclick=()=>document.body.classList.toggle('hide-ui');

createInstances(1);
</script>
</body>
</html>
