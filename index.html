<script>
  let links = [];
  let currentIndex = -1;
  let historyStack = [];
  let forwardStack = [];
  const maxHistory = 3;
  const maxPreload = 3;

  const imgElement = document.getElementById('mainImage');
  const backBtn = document.getElementById('backBtn');
  const forwardBtn = document.getElementById('forwardBtn');

  function updateButtons() {
    backBtn.disabled = historyStack.length === 0;
    forwardBtn.disabled = forwardStack.length === 0;
  }

  function preloadForwardImages() {
    forwardStack = [];
    let preloadCount = 0;
    for (let i = 0; i < links.length && preloadCount < maxPreload; i++) {
      const randomIndex = Math.floor(Math.random() * links.length);
      if (randomIndex !== currentIndex && !forwardStack.includes(randomIndex) && !historyStack.includes(randomIndex)) {
        const img = new Image();
        img.onload = () => {
          forwardStack.push(randomIndex);
          updateButtons();
        };
        img.src = links[randomIndex];
        preloadCount++;
      }
    }
  }

  function showImage(index) {
    currentIndex = index;
    imgElement.src = links[currentIndex];
    imgElement.alt = `Image ${currentIndex + 1} of ${links.length}`;
    preloadForwardImages();
    updateButtons();
  }

  backBtn.addEventListener('click', () => {
    if (historyStack.length > 0) {
      forwardStack.unshift(currentIndex);
      if (forwardStack.length > maxPreload) forwardStack.pop();
      const prevIndex = historyStack.pop();
      showImage(prevIndex);
    }
  });

  forwardBtn.addEventListener('click', () => {
    if (forwardStack.length > 0) {
      historyStack.push(currentIndex);
      if (historyStack.length > maxHistory) historyStack.shift();
      const nextIndex = forwardStack.shift();
      showImage(nextIndex);
    }
  });

  document.addEventListener('keydown', (event) => {
    if (event.key === 'ArrowLeft') backBtn.click();
    else if (event.key === 'ArrowRight') forwardBtn.click();
  });

  // Only load from the fixed URL
  async function loadFixedTxtLinks() {
    try {
      const url = 'https://f003.backblazeb2.com/file/links-ref/friendly_urls.txt';
      const res = await fetch(url);
      const fileContent = await res.text();
      links = fileContent.trim().split('\n').filter(Boolean);
      if (links.length === 0) {
        imgElement.alt = "No links found in the file.";
        return;
      }
      currentIndex = Math.floor(Math.random() * links.length);
      showImage(currentIndex);
    } catch (err) {
      console.error(err);
      imgElement.alt = "Failed to load links from the fixed .txt file.";
    }
  }

  loadFixedTxtLinks();
</script>
