<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Ref Navigator Pro</title>
  <style>
    :root { --bg: #0b0b0b; --ui-bg: rgba(30,30,30,0.85); --accent: #4a90e2; }
    body {
      margin: 0; padding: 0; background: var(--bg); color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
      height: 100vh; overflow: hidden; user-select: none;
    }

    /* Image Layer */
    .viewport {
      width: 100vw; height: 100vh; display: flex; 
      align-items: center; justify-content: center; overflow: hidden;
    }
    #mainImage {
      max-width: 100%; max-height: 100%; object-fit: contain;
      border: 2px solid #333; border-radius: 4px;
      transition: transform 0.15s cubic-bezier(0.2, 0, 0.2, 1);
      will-change: transform; cursor: grab;
    }
    #mainImage:active { cursor: grabbing; }

    /* UI Components */
    .panel { position: fixed; z-index: 100; display: flex; gap: 8px; pointer-events: none; }
    .panel > * { pointer-events: auto; }
    
    .top-bar { top: 10px; left: 10px; right: 10px; justify-content: space-between; align-items: start; }
    .bottom-bar { bottom: 20px; left: 50%; transform: translateX(-50%); }
    .side-nav { top: 50%; width: 100%; transform: translateY(-50%); justify-content: space-between; padding: 0 15px; box-sizing: border-box; }

    /* Inputs & Buttons */
    .search-input { 
      background: var(--ui-bg); border: 1px solid #444; color: #fff;
      padding: 8px 12px; border-radius: 20px; outline: none; width: 180px;
    }
    .tag-grid { 
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
      background: var(--ui-bg); padding: 8px; border-radius: 12px;
    }
    .tag-grid label {
      display: flex; align-items: center; justify-content: center;
      width: 32px; height: 32px; border-radius: 6px; background: #222;
      font-weight: bold; font-size: 0.8em; cursor: pointer; transition: 0.2s;
    }
    .tag-grid input:checked + span { color: var(--accent); text-shadow: 0 0 5px var(--accent); }
    .tag-grid input { display: none; }

    button {
      background: var(--ui-bg); border: none; color: #fff;
      padding: 10px 18px; border-radius: 8px; cursor: pointer;
      font-size: 1.1em; transition: 0.2s; backdrop-filter: blur(5px);
    }
    button:hover { background: #444; }
    button:disabled { opacity: 0.2; cursor: not-allowed; }

    .hidden-ui .panel, .hidden-ui .version { display: none !important; }
    .version { position: fixed; bottom: 5px; right: 10px; font-size: 10px; opacity: 0.4; }
    
    /* Utilities */
    .loading-spin { animation: spin 1s infinite linear; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="panel top-bar">
  <input type="text" id="searchInput" class="search-input" placeholder="Search tags...">
  <div id="categoryGrid" class="tag-grid"></div>
  <button id="uiToggle">‚ò∞</button>
</div>

<div class="viewport">
  <img id="mainImage" draggable="false" />
</div>

<div class="panel side-nav">
  <button id="backBtn">‚Üê</button>
  <button id="forwardBtn">‚Üí</button>
</div>

<div class="panel bottom-bar">
  <button id="resetBtn" title="Reset">‚Üª</button>
  <button id="flipBtn" title="Flip">‚Üî</button>
  <button id="copyBtn" title="Copy URL">üìã</button>
  <button id="openBtn" title="Open Original">üîó</button>
</div>

<div class="version">V4.0 (Optimized)</div>

<script>
  const baseURL = 'https://f003.backblazeb2.com/file/linksref2/';
  const categories = [
    {v:"People",l:"P"},{v:"pplus",l:"p"},{v:"Anime",l:"A"},{v:"angle",l:"a"},{v:"Figure",l:"F"},{v:"Style",l:"S"},
    {v:"XMaleAnatomy",l:"X"},{v:"Emotions",l:"E"},{v:"Background",l:"B"},{v:"Walk",l:"W"},{v:"screencap",l:"s"},{v:"Manga",l:"M"},
    {v:"moeManga",l:"m"},{v:"TestPanel",l:"T"}
  ];

  // State Management
  const state = {
    sourceData: {},
    history: [],
    forward: [],
    currentIndex: -1,
    transform: { x: 0, y: 0, scale: 1, flipped: false },
    isDragging: false,
    start: { x: 0, y: 0 }
  };

  const img = document.getElementById('mainImage');
  const catGrid = document.getElementById('categoryGrid');

  /** 1. Initialize UI **/
  function init() {
    categories.forEach(cat => {
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" value="${cat.v}"><span>${cat.l}</span>`;
      catGrid.appendChild(label);
    });

    bindEvents();
    // Load first selection if any
    const firstCheck = catGrid.querySelector('input');
    firstCheck.checked = true;
    updateLibrary();
  }

  /** 2. Networking **/
  async function updateLibrary() {
    const active = [...catGrid.querySelectorAll('input:checked')].map(i => i.value);
    for (const val of active) {
      if (!state.sourceData[val]) {
        try {
          const res = await fetch(`${baseURL}${val}.txt`);
          const text = await res.text();
          state.sourceData[val] = text.split('\n').filter(l => l.trim().length > 5);
        } catch (e) { console.error("Fetch failed", val); }
      }
    }
    if (state.currentIndex === -1) nextImage();
  }

  /** 3. Image Logic **/
  function getFilteredPool() {
    const activeKeys = [...catGrid.querySelectorAll('input:checked')].map(i => i.value);
    const query = document.getElementById('searchInput').value.toLowerCase();
    let pool = [];
    activeKeys.forEach(k => {
      if (state.sourceData[k]) pool.push(...state.sourceData[k]);
    });
    return query ? pool.filter(url => url.toLowerCase().includes(query)) : pool;
  }

  function nextImage() {
    const pool = getFilteredPool();
    if (!pool.length) return alert("No images match selection.");
    
    if (img.src) state.history.push(img.src);
    if (state.history.length > 20) state.history.shift();
    
    const newUrl = pool[Math.floor(Math.random() * pool.length)];
    loadImage(newUrl);
  }

  function prevImage() {
    if (state.history.length) {
      const prev = state.history.pop();
      loadImage(prev);
    }
  }

  function loadImage(url) {
    img.style.opacity = '0.3';
    const temp = new Image();
    temp.onload = () => {
      img.src = url;
      img.style.opacity = '1';
      resetTransform();
    };
    temp.src = url;
    updateButtonStates();
  }

  /** 4. Transforms **/
  function updateStyle() {
    const { x, y, scale, flipped } = state.transform;
    img.style.transform = `translate(${x}px, ${y}px) scale(${scale * (flipped ? -1 : 1)}, ${scale})`;
  }

  function resetTransform() {
    state.transform = { x: 0, y: 0, scale: 1, flipped: false };
    updateStyle();
  }

  /** 5. Event Listeners **/
  function bindEvents() {
    // Inputs
    catGrid.addEventListener('change', updateLibrary);
    document.getElementById('searchInput').addEventListener('input', () => {}); // Optional: live filter

    // Navigation
    document.getElementById('forwardBtn').onclick = nextImage;
    document.getElementById('backBtn').onclick = prevImage;
    
    // Tools
    document.getElementById('resetBtn').onclick = resetTransform;
    document.getElementById('flipBtn').onclick = () => { state.transform.flipped = !state.transform.flipped; updateStyle(); };
    document.getElementById('uiToggle').onclick = () => document.body.classList.toggle('hidden-ui');
    document.getElementById('copyBtn').onclick = () => { navigator.clipboard.writeText(img.src); alert("Copied!"); };
    document.getElementById('openBtn').onclick = () => window.open(img.src, '_blank');

    // Dragging
    img.onmousedown = (e) => {
      state.isDragging = true;
      state.start = { x: e.clientX - state.transform.x, y: e.clientY - state.transform.y };
    };
    window.onmousemove = (e) => {
      if (!state.isDragging) return;
      state.transform.x = e.clientX - state.start.x;
      state.transform.y = e.clientY - state.start.y;
      requestAnimationFrame(updateStyle);
    };
    window.onmouseup = () => state.isDragging = false;

    // Zoom
    window.onwheel = (e) => {
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      state.transform.scale = Math.min(Math.max(0.2, state.transform.scale + delta), 5);
      updateStyle();
    };

    // Keys
    document.onkeydown = (e) => {
      if (document.activeElement.tagName === 'INPUT') return;
      const key = e.key.toLowerCase();
      if (key === 'd' || key === 'arrowright') nextImage();
      if (key === 'a' || key === 'arrowleft') prevImage();
      if (key === 'r') resetTransform();
      if (key === 'f') { state.transform.flipped = !state.transform.flipped; updateStyle(); }
    };
  }

  function updateButtonStates() {
    document.getElementById('backBtn').disabled = state.history.length === 0;
  }

  init();
</script>
</body>
</html>
