<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Ref Navigator Pro</title>
  <style>
    :root { --bg: #0b0b0b; --ui-bg: rgba(20,20,20,0.9); --accent: #4a90e2; }
    body {
      margin: 0; padding: 0; background: var(--bg); color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
      height: 100vh; overflow: hidden; user-select: none;
    }

    .viewport { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    #mainImage { 
      max-width: 100%; max-height: 100%; object-fit: contain; 
      will-change: transform; transition: transform 0.1s ease-out;
    }

    .panel { position: fixed; z-index: 100; display: flex; gap: 8px; pointer-events: none; }
    .panel > * { pointer-events: auto; }
    .top-bar { top: 10px; left: 10px; right: 10px; justify-content: space-between; }
    .bottom-bar { bottom: 20px; left: 50%; transform: translateX(-50%); }
    .side-nav { top: 50%; width: 100%; transform: translateY(-50%); justify-content: space-between; padding: 0 15px; box-sizing: border-box; }

    .tag-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; background: var(--ui-bg); padding: 8px; border-radius: 12px; }
    .tag-grid label { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; background: #333; cursor: pointer; font-size: 0.8em; }
    .tag-grid input:checked + span { color: var(--accent); font-weight: bold; }
    .tag-grid input { display: none; }

    button { background: var(--ui-bg); border: none; color: #fff; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1.2em; }
    button:disabled { opacity: 0.2; }

    .hidden-ui .panel { display: none !important; }
    #loadingIndicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; pointer-events: none; }
  </style>
</head>
<body>

<div class="panel top-bar">
  <input type="text" id="searchInput" style="border-radius:20px; padding:5px 15px; border:1px solid #444; background:#000; color:#fff" placeholder="Search tags...">
  <div id="categoryGrid" class="tag-grid"></div>
</div>

<div class="viewport"><img id="mainImage" draggable="false" /></div>
<div id="loadingIndicator">Loading...</div>

<div class="panel side-nav">
  <button id="backBtn">‚Üê</button>
  <button id="forwardBtn">‚Üí</button>
</div>

<div class="panel bottom-bar">
  <button id="resetBtn">‚Üª</button>
  <button id="flipBtn">‚Üî</button>
  <button id="copyBtn">üìã</button>
</div>

<script>
  const baseURL = 'https://f003.backblazeb2.com/file/linksref2/';
  const categories = [
    {v:"People",l:"P"},{v:"pplus",l:"p"},{v:"Anime",l:"A"},{v:"angle",l:"a"},{v:"Figure",l:"F"},{v:"Style",l:"S"},
    {v:"XMaleAnatomy",l:"X"},{v:"Emotions",l:"E"},{v:"Background",l:"B"},{v:"Walk",l:"W"},{v:"screencap",l:"s"},{v:"Manga",l:"M"},
    {v:"moeManga",l:"m"},{v:"TestPanel",l:"T"}
  ];

  const state = {
    sources: {},
    backStack: [],    // History
    forwardStack: [], // Future (when navigating back)
    preloadQueue: [], // The 8-image buffer
    transform: { x: 0, y: 0, scale: 1, flipped: false },
    isDragging: false,
    start: { x: 0, y: 0 }
  };

  const img = document.getElementById('mainImage');
  const catGrid = document.getElementById('categoryGrid');

  /** 1. System Setup **/
  function init() {
    categories.forEach(cat => {
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" value="${cat.v}"><span>${cat.l}</span>`;
      catGrid.appendChild(label);
    });
    bindEvents();
    catGrid.querySelector('input').checked = true;
    updateLibrary();
  }

  /** 2. Fetching & Preloading **/
  async function updateLibrary() {
    const active = [...catGrid.querySelectorAll('input:checked')].map(i => i.value);
    for (const val of active) {
      if (!state.sources[val]) {
        try {
          const res = await fetch(`${baseURL}${val}.txt`);
          const text = await res.text();
          state.sources[val] = text.split('\n').filter(l => l.trim().length > 5);
        } catch (e) { console.error(e); }
      }
    }
    fillPreloadQueue();
    if (!img.src) navigateForward();
  }

  function fillPreloadQueue() {
    const activeKeys = [...catGrid.querySelectorAll('input:checked')].map(i => i.value);
    const query = document.getElementById('searchInput').value.toLowerCase();
    
    let pool = [];
    activeKeys.forEach(k => { if (state.sources[k]) pool.push(...state.sources[k]); });
    if (query) pool = pool.filter(url => url.toLowerCase().includes(query));

    while (state.preloadQueue.length < 8 && pool.length > 0) {
      const url = pool[Math.floor(Math.random() * pool.length)];
      const pImg = new Image();
      pImg.src = url; // Trigger browser cache
      state.preloadQueue.push(url);
    }
  }

  /** 3. Navigation Core **/
  function navigateForward() {
    if (state.forwardStack.length > 0) {
      // Browsing forward through existing history
      if (img.src) state.backStack.push(img.src);
      displayImage(state.forwardStack.shift());
    } else if (state.preloadQueue.length > 0) {
      // Moving to a brand new image
      if (img.src) state.backStack.push(img.src);
      if (state.backStack.length > 5) state.backStack.shift();
      
      displayImage(state.preloadQueue.shift());
      fillPreloadQueue();
    }
    updateUI();
  }

  function navigateBackward() {
    if (state.backStack.length > 0) {
      if (img.src) state.forwardStack.unshift(img.src);
      if (state.forwardStack.length > 5) state.forwardStack.pop();
      
      displayImage(state.backStack.pop());
    }
    updateUI();
  }

  function displayImage(url) {
    img.src = url;
    resetTransform();
  }

  /** 4. Controls & Hotkeys **/
  function updateTransform() {
    const { x, y, scale, flipped } = state.transform;
    img.style.transform = `translate(${x}px, ${y}px) scale(${scale * (flipped ? -1 : 1)}, ${scale})`;
  }

  function resetTransform() {
    state.transform = { x: 0, y: 0, scale: 1, flipped: false };
    updateTransform();
  }

  function bindEvents() {
    document.getElementById('forwardBtn').onclick = navigateForward;
    document.getElementById('backBtn').onclick = navigateBackward;
    document.getElementById('resetBtn').onclick = resetTransform;
    document.getElementById('flipBtn').onclick = () => { state.transform.flipped = !state.transform.flipped; updateTransform(); };
    catGrid.onchange = () => { state.preloadQueue = []; updateLibrary(); };

    // Keyboard
    document.onkeydown = (e) => {
      if (e.target.tagName === 'INPUT') return;
      const key = e.key.toLowerCase();
      
      if (key === 'd') navigateForward();
      if (key === 'a') navigateBackward();
      if (key === 'w') { state.transform.scale += 0.2; updateTransform(); }
      if (key === 's') { state.transform.scale = Math.max(0.1, state.transform.scale - 0.2); updateTransform(); }
      if (key === 'u') document.body.classList.toggle('hidden-ui');
      if (key === 'r') resetTransform();
      if (key === 'f') { state.transform.flipped = !state.transform.flipped; updateTransform(); }
    };

    // Dragging Logic
    img.onmousedown = (e) => {
      state.isDragging = true;
      state.start = { x: e.clientX - state.transform.x, y: e.clientY - state.transform.y };
      img.style.cursor = 'grabbing';
    };
    window.onmousemove = (e) => {
      if (!state.isDragging) return;
      state.transform.x = e.clientX - state.start.x;
      state.transform.y = e.clientY - state.start.y;
      updateTransform();
    };
    window.onmouseup = () => { state.isDragging = false; img.style.cursor = 'grab'; };
  }

  function updateUI() {
    document.getElementById('backBtn').disabled = state.backStack.length === 0;
    document.getElementById('forwardBtn').disabled = (state.forwardStack.length === 0 && state.preloadQueue.length === 0);
  }

  init();
</script>
</body>
</html>
