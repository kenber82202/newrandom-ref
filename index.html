<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Ref Navigator - Filtered Pro</title>
  <style>
    :root { --bg: #000; --ui-bg: rgba(20,20,20,0.95); --accent: #4a90e2; }
    body { margin: 0; background: var(--bg); color: #fff; font-family: system-ui, sans-serif; height: 100vh; width: 100vw; overflow: hidden; }
    
    .viewport { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1; overflow: hidden; }
    #mainImage { width: 100vw; height: 100vh; object-fit: contain; will-change: transform; transition: opacity 0.2s; cursor: grab; }
    
    .ui-layer { position: fixed; z-index: 100; display: flex; pointer-events: none; transition: opacity 0.2s; }
    .ui-layer > * { pointer-events: auto; }

    .top-bar { top: 10px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; gap: 8px; width: auto; }
    .category-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; background: var(--ui-bg); padding: 5px; border-radius: 10px; border: 1px solid #333; }
    
    .cat-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #333; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; color: #888; }
    .cat-btn input { display: none; }
    .cat-btn:has(input:checked) { background: var(--accent); color: #fff; }

    .nav-layer { inset: 0; justify-content: space-between; align-items: center; padding: 0 10px; }
    .nav-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); color: #fff; font-size: 24px; padding: 25px 12px; border-radius: 8px; cursor: pointer; }
    .nav-btn:disabled { opacity: 0; pointer-events: none; }

    .bottom-bar { bottom: 20px; left: 50%; transform: translateX(-50%); gap: 15px; background: var(--ui-bg); padding: 8px 20px; border-radius: 20px; border: 1px solid #333; }
    .tool-btn { background: none; border: none; color: #aaa; font-size: 18px; cursor: pointer; }
    
    #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--ui-bg); padding: 12px 24px; border-radius: 10px; border: 1px solid var(--accent); display: none; z-index: 1000; font-size: 12px; letter-spacing: 1px; text-align: center;}
    .hidden-ui .ui-layer { display: none !important; }
  </style>
</head>
<body>

<div class="ui-layer top-bar">
  <div id="catWrapper" class="category-container"></div>
</div>

<div class="viewport">
  <img id="mainImage" draggable="false" />
</div>

<div id="loader">SNIPING...</div>

<div class="ui-layer nav-layer">
  <button id="backBtn" class="nav-btn">‚ùÆ</button>
  <button id="fwdBtn" class="nav-btn">‚ùØ</button>
</div>

<div class="ui-layer bottom-bar">
  <button id="resetBtn" class="tool-btn">‚Üª</button>
  <button id="flipBtn" class="tool-btn">‚Üî</button>
  <button id="copyBtn" class="tool-btn">üìã</button>
  <button id="uiBtn" class="tool-btn">üëÅ</button>
</div>

<script>
  const baseURL = 'https://f003.backblazeb2.com/file/linksref2/';
  const categories = [
    {v:"People",l:"P"},{v:"pplus",l:"p"},{v:"Anime",l:"A"},{v:"angle",l:"a"},{v:"Figure",l:"F"},{v:"Style",l:"S"},
    {v:"XMaleAnatomy",l:"X"},{v:"Emotions",l:"E"},{v:"Background",l:"B"},{v:"Walk",l:"W"},{v:"screencap",l:"s"},{v:"Manga",l:"M"},
    {v:"moeManga",l:"m"},{v:"TestPanel",l:"T"}
  ];

  const state = {
    fileSizes: {},
    history: [],
    index: -1,
    prefetched: null,
    transform: { x:0, y:0, scale:1, flipped:false },
    isDragging: false,
    dragStart: { x:0, y:0 },
    minSize: 250 // Filter out images smaller than this
  };

  const el = {
    img: document.getElementById('mainImage'),
    cats: document.getElementById('catWrapper'),
    loader: document.getElementById('loader'),
    btnBack: document.getElementById('backBtn'),
    btnFwd: document.getElementById('fwdBtn')
  };

  function init() {
    categories.forEach(cat => {
      const label = document.createElement('label');
      label.className = 'cat-btn';
      label.innerHTML = `<input type="checkbox" value="${cat.v}">${cat.l}`;
      el.cats.appendChild(label);
    });
    el.cats.querySelector('input').checked = true;
    
    bindControls();
    navigateForward();
  }

  async function getFileSize(cat) {
    if (state.fileSizes[cat]) return state.fileSizes[cat];
    try {
      const resp = await fetch(baseURL + cat + '.txt', { method: 'HEAD' });
      const size = parseInt(resp.headers.get('content-length'));
      state.fileSizes[cat] = size;
      return size;
    } catch(e) { return 100000; }
  }

  // SNIPER: Includes Retry Logic & Anti-Hang Timeout
  async function sniperFetch(retryCount = 0) {
    if (retryCount > 5) return null; // Give up after 5 tries

    const active = [...el.cats.querySelectorAll('input:checked')].map(i => i.value);
    if (!active.length) return null;
    
    const cat = active[Math.floor(Math.random() * active.length)];
    const totalSize = await getFileSize(cat);
    const randomPos = Math.floor(Math.random() * (totalSize - 3000));
    
    // Create a controller to kill the fetch if it hangs
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 2000);

    try {
      const resp = await fetch(baseURL + cat + '.txt', {
        headers: { 'Range': `bytes=${randomPos}-${randomPos + 2500}` },
        signal: controller.signal
      });
      clearTimeout(timeout);
      
      const chunk = await resp.text();
      const lines = chunk.split('\n');
      const validLines = lines.slice(1, -1).filter(l => l.length > 10);
      
      if (validLines.length === 0) return sniperFetch(retryCount + 1);

      const url = validLines[Math.floor(Math.random() * validLines.length)].trim();
      
      // Check image size before validating it for prefetch
      const isGood = await validateImageSize(url);
      if (!isGood) return sniperFetch(retryCount + 1);

      return url;
    } catch (e) {
      return sniperFetch(retryCount + 1);
    }
  }

  // SIZE FILTER: Checks dimensions naturalWidth/Height
  function validateImageSize(url) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const isBigEnough = img.naturalWidth >= state.minSize && img.naturalHeight >= state.minSize;
        resolve(isBigEnough);
      };
      img.onerror = () => resolve(false);
      img.src = url;
    });
  }

  async function navigateForward() {
    if (state.index < state.history.length - 1) {
      state.index++;
      displayImage(state.history[state.index]);
      return;
    }

    el.loader.style.display = 'block';
    el.loader.innerText = "SNIPING...";
    
    let url = state.prefetched;
    state.prefetched = null; // Use it and clear it

    if (!url) url = await sniperFetch();
    
    if (url) {
      state.history.push(url);
      state.index = state.history.length - 1;
      displayImage(url);
    } else {
      el.loader.innerText = "FAILED TO SNIPE. RETRYING...";
      setTimeout(navigateForward, 500);
    }
  }

  function navigateBack() {
    if (state.index > 0) {
      state.index--;
      displayImage(state.history[state.index]);
    }
  }

  function displayImage(url) {
    el.img.style.opacity = '0.3';
    el.loader.style.display = 'block';
    el.loader.innerText = "LOADING IMAGE...";
    
    const temp = new Image();
    temp.onload = () => {
      el.img.src = url;
      el.img.style.opacity = '1';
      el.loader.style.display = 'none';
      resetTransform();
      updateButtons();
      prepareNext(); // Pre-snipe for the next click
    };
    temp.onerror = () => {
      state.history.splice(state.index, 1);
      state.index--;
      navigateForward();
    };
    temp.src = url;
  }

  async function prepareNext() {
    state.prefetched = await sniperFetch();
  }

  function updateButtons() {
    el.btnBack.disabled = state.index <= 0;
  }

  function applyTransform() {
    const {x, y, scale, flipped} = state.transform;
    el.img.style.transform = `translate(${x}px, ${y}px) scale(${scale * (flipped ? -1 : 1)}, ${scale})`;
  }

  function resetTransform() {
    state.transform = { x:0, y:0, scale:1, flipped:false };
    applyTransform();
  }

  function bindControls() {
    el.btnFwd.onclick = navigateForward;
    el.btnBack.onclick = navigateBack;
    document.getElementById('resetBtn').onclick = resetTransform;
    document.getElementById('flipBtn').onclick = () => { state.transform.flipped = !state.transform.flipped; applyTransform(); };
    document.getElementById('uiBtn').onclick = () => document.body.classList.toggle('hidden-ui');
    document.getElementById('copyBtn').onclick = () => { 
      if(state.history[state.index]) navigator.clipboard.writeText(state.history[state.index]); 
    };

    el.cats.onchange = () => {
      state.history = [];
      state.index = -1;
      state.prefetched = null;
      navigateForward();
    };

    document.onkeydown = (e) => {
      const k = e.key.toLowerCase();
      if (k === 'd' || k === 'arrowright') navigateForward();
      if (k === 'a' || k === 'arrowleft') navigateBack();
      if (k === 'w') { state.transform.scale += 0.2; applyTransform(); }
      if (k === 's') { state.transform.scale = Math.max(0.1, state.transform.scale - 0.2); applyTransform(); }
      if (k === 'f') document.getElementById('flipBtn').click();
      if (k === 'r') resetTransform();
      if (k === 'u') document.body.classList.toggle('hidden-ui');
    };

    const start = (x, y) => { state.isDragging = true; state.dragStart = { x: x - state.transform.x, y: y - state.transform.y }; };
    const move = (x, y) => { if (state.isDragging) { state.transform.x = x - state.dragStart.x; state.transform.y = y - state.dragStart.y; applyTransform(); } };
    el.img.onmousedown = e => start(e.clientX, e.clientY);
    window.onmousemove = e => move(e.clientX, e.clientY);
    window.onmouseup = () => state.isDragging = false;
    el.img.ontouchstart = e => start(e.touches[0].clientX, e.touches[0].clientY);
    window.ontouchend = () => state.isDragging = false;
  }

  init();
</script>
</body>
</html>
