<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ultra Fast Preload Image Navigator</title>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  height:100vh;
  overflow:hidden;
}

#topControls{
  position:fixed;
  top:5px;
  z-index:1000;
  display:flex;
  gap:10px;
  background:rgba(0,0,0,0.5);
  padding:5px 10px;
  border-radius:8px;
}

body.hide-ui #topControls,
body.hide-ui .toggles,
body.hide-ui .search-bar,
body.hide-ui .controls{
  display:none;
}

#instancesContainer{
  margin-top:50px;
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  gap:5px;
}

.instance{
  position:relative;
  flex:1;
}

.image-wrapper{
  width:100%;
  height:100%;
  position:relative;
  overflow:hidden;
}

.instance img{
  width:100%;
  height:100%;
  object-fit:cover;
  position:absolute;
  inset:0;
  border:2px solid #fff;
  border-radius:6px;
}

.nav-arrow{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  font-size:48px;
  color:white;
  opacity:0.5;
  cursor:pointer;
  z-index:20;
  user-select:none;
}
.nav-arrow.left{left:10px;}
.nav-arrow.right{right:10px;}

.toggles,.search-bar,.controls{
  position:absolute;
  z-index:10;
  background:rgba(0,0,0,0.5);
  padding:3px 5px;
  border-radius:4px;
  display:flex;
  gap:4px;
  flex-wrap:wrap;
}

.toggles{top:5px;left:50%;transform:translateX(-50%);}
.search-bar{top:5px;left:5px;}
.controls{bottom:5px;left:50%;transform:translateX(-50%);}
</style>
</head>

<body>

<div id="topControls">
  <label>Instances:
    <select id="instanceCount">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </label>
  <button id="hideUIBtn">Hide UI</button>
</div>

<div id="instancesContainer"></div>

<script>
const baseURL = 'https://f003.backblazeb2.com/file/linksref2/';
const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
const IMAGE_EXT = /\.(jpg|jpeg|png|webp|gif|avif|bmp)$/i;

let instances = [];

const categories = [
  {v:"People",l:"P"},{v:"Anime",l:"A"},
  {v:"Background",l:"B"},{v:"Walk",l:"W"}
];

class ImageInstance{
  constructor(){
    this.history=[];
    this.future=[];
    this.sourceLists={};
    this.preloadImages=[];
    this.gen=0;
    this.createUI();
  }

  createUI(){
    this.el=document.createElement('div');
    this.el.className='instance';

    this.el.innerHTML=`
      <div class="toggles">
        ${categories.map(c=>`<label><input type="checkbox" value="${c.v}">${c.l}</label>`).join('')}
      </div>
      <div class="image-wrapper">
        <div class="nav-arrow left">&#10094;</div>
        <div class="nav-arrow right">&#10095;</div>
        <img>
      </div>
    `;

    this.img=this.el.querySelector('img');
    this.el.querySelector('.left').onclick=()=>this.back();
    this.el.querySelector('.right').onclick=()=>this.forward();
    this.checks=this.el.querySelectorAll('input');
    this.checks.forEach(c=>c.onchange=()=>this.reloadSources());
  }

  async fetchLinks(subject){
    try{
      const url = CORS_PROXY + encodeURIComponent(`${baseURL}${subject}.txt`);
      const r = await fetch(url);
      const text = await r.text();
      return text.split('\n').map(l=>l.trim()).filter(l=>IMAGE_EXT.test(l));
    }catch(e){
      console.error("Fetch failed:", subject, e);
      return [];
    }
  }

  async reloadSources(){
    this.gen++;
    const myGen=this.gen;

    const sel=[...this.checks].filter(c=>c.checked).map(c=>c.value);
    if(!sel.length) return;

    const res=await Promise.all(sel.map(s=>this.fetchLinks(s)));
    if(this.gen!==myGen) return;

    this.sourceLists=Object.fromEntries(sel.map((s,i)=>[s,res[i]]));
    this.history=[]; this.future=[]; this.preloadImages=[];
    this.forward(true);
  }

  async randomImage(){
    const keys=Object.keys(this.sourceLists);
    if(!keys.length) return null;

    for(let i=0;i<30;i++){
      const k=keys[Math.floor(Math.random()*keys.length)];
      const list=this.sourceLists[k];
      if(!list.length) continue;
      return list[Math.floor(Math.random()*list.length)];
    }
    return null;
  }

  preloadNext(max=4){
    const myGen=this.gen;
    while(this.preloadImages.length<max){
      this.randomImage().then(url=>{
        if(this.gen!==myGen) return;
        if(url) this.preloadImages.push(url);
      });
    }
  }

  async forward(force=false){
    if(!force && this.future.length){
      const n=this.future.shift();
      this.history.push(this.img.src);
      if(this.history.length>4) this.history.shift();
      this.show(n);
      return;
    }

    if(this.img.src){
      this.history.push(this.img.src);
      if(this.history.length>4) this.history.shift();
    }

    const next=this.preloadImages.length
      ? this.preloadImages.shift()
      : await this.randomImage();

    if(next) this.show(next);
    this.future=[];
    this.preloadNext();
  }

  back(){
    if(!this.history.length) return;
    this.future.unshift(this.img.src);
    if(this.future.length>4) this.future.pop();
    this.show(this.history.pop());
  }

  show(url){
    this.img.src=url;
  }
}

function createInstances(n){
  const c=document.getElementById('instancesContainer');
  c.innerHTML='';
  instances=[];
  for(let i=0;i<n;i++){
    const inst=new ImageInstance();
    instances.push(inst);
    c.appendChild(inst.el);
  }
}

document.getElementById('instanceCount').onchange=e=>createInstances(+e.target.value);
document.getElementById('hideUIBtn').onclick=()=>document.body.classList.toggle('hide-ui');

createInstances(1);
</script>
</body>
</html>
