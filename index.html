<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Multi Instance Image Navigator</title>
<style>
  body {
    margin:0;background:#000;color:#fff;font-family:sans-serif;
    display:flex;flex-direction:column;align-items:center;
  }
  #topControls {
    position:fixed;top:5px;z-index:1000;display:flex;gap:10px;
    background:rgba(0,0,0,0.5);padding:5px 10px;border-radius:8px;
  }
  #instancesContainer {
    margin-top:60px;width:100%;display:flex;flex-direction:column;gap:20px;
  }
  .instance {
    position:relative;width:100%;height:33vh;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
  }
  .instance .image-container {
    position:relative;width:100%;height:100%;overflow:hidden;
  }
  .instance img {
    max-width:100%;max-height:100%;
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(1);
    object-fit:contain;border:2px solid #fff;border-radius:8px;
    transition:transform 0.1s ease-out;
  }
  .instance .toggles {
    position:absolute;top:5px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.5);padding:5px;border-radius:6px;display:flex;gap:5px;
  }
  .instance .search-bar {
    position:absolute;top:5px;left:5px;
  }
  .instance .controls {
    position:absolute;bottom:5px;left:50%;transform:translateX(-50%);
    display:flex;gap:10px;
  }
  .instance button {
    background:rgba(30,30,30,0.8);color:#fff;border:none;border-radius:5px;padding:5px 10px;
  }
</style>
</head>
<body>
<div id="topControls">
  <label>Instances:
    <select id="instanceCount">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </label>
</div>
<div id="instancesContainer"></div>

<script>
const baseURL='https://f003.backblazeb2.com/file/links-ref/';
const hotkeys={1:{flip:'f',reset:'r'},2:{flip:'g',reset:'t'},3:{flip:'h',reset:'y'}};
let instances=[];

class ImageInstance{
  constructor(id,hotkeys){
    this.id=id;this.hotkeys=hotkeys;this.scale=1;this.isFlipped=false;
    this.translate={x:0,y:0};this.historyStack=[];this.forwardStack=[];
    this.sourceLists={};this.currentImage=null;
    this.createUI();
  }

  createUI(){
    this.el=document.createElement('div');
    this.el.className='instance';
    this.el.innerHTML=`
      <div class="search-bar"><input placeholder="Search (#tag)"></div>
      <div class="toggles">${["People","Places","Anime","Style"].map(c=>`
        <label><input type="checkbox" value="${c}">${c[0]}</label>`).join('')}</div>
      <div class="image-container"><img draggable="false"></div>
      <div class="controls">
        <button class="flipBtn">Flip (${this.hotkeys.flip.toUpperCase()})</button>
        <button class="resetBtn">Reset (${this.hotkeys.reset.toUpperCase()})</button>
      </div>`;
    document.getElementById('instancesContainer').appendChild(this.el);
    this.imgElement=this.el.querySelector('img');
    this.searchInput=this.el.querySelector('input');
    this.checkboxes=this.el.querySelectorAll('input[type=checkbox]');
    this.flipBtn=this.el.querySelector('.flipBtn');
    this.resetBtn=this.el.querySelector('.resetBtn');
    this.flipBtn.addEventListener('click',()=>this.flipImage());
    this.resetBtn.addEventListener('click',()=>this.resetImagePosition());
    this.checkboxes.forEach(cb=>cb.addEventListener('change',()=>this.loadSelectedSources()));
    this.searchInput.addEventListener('input',()=>this.loadSelectedSources());
    this.addDragging();
  }

  addDragging(){
    let isDragging=false,startPos={x:0,y:0};
    this.imgElement.addEventListener('mousedown',e=>{
      e.preventDefault();isDragging=true;startPos={x:e.clientX,y:e.clientY};
    });
    document.addEventListener('mousemove',e=>{
      if(!isDragging)return;
      this.translate.x+=e.clientX-startPos.x;
      this.translate.y+=e.clientY-startPos.y;
      startPos={x:e.clientX,y:e.clientY};
      this.updateTransform();
    });
    document.addEventListener('mouseup',()=>{isDragging=false;});
  }

  updateTransform(){
    const flip=this.isFlipped?-1:1;
    this.imgElement.style.transform=
      `translate(calc(-50% + ${this.translate.x}px),calc(-50% + ${this.translate.y}px)) scale(${flip*this.scale},${this.scale})`;
  }

  resetImagePosition(){
    this.scale=1;this.isFlipped=false;this.translate={x:0,y:0};this.updateTransform();
  }

  flipImage(){this.isFlipped=!this.isFlipped;this.updateTransform();}

  async fetchLinksFor(subject){
    try{
      const res=await fetch(`${baseURL}${subject}.txt`);
      const txt=await res.text();
      return txt.trim().split('\n').filter(Boolean);
    }catch{return [];}
  }

  async loadSelectedSources(){
    const selected=[...this.checkboxes].filter(c=>c.checked).map(c=>c.value);
    if(!selected.length)return;
    const results=await Promise.all(selected.map(s=>this.fetchLinksFor(s)));
    this.sourceLists=Object.fromEntries(selected.map((s,i)=>[s,results[i]]));
    this.showRandomImage();
  }

  getRandomImageSource(){
    const subjects=Object.keys(this.sourceLists);
    if(!subjects.length)return null;
    const chosen=subjects[Math.floor(Math.random()*subjects.length)];
    const links=this.filterBySearch(this.sourceLists[chosen]);
    if(!links.length)return null;
    return {subject:chosen,url:links[Math.floor(Math.random()*links.length)]};
  }

  filterBySearch(list){
    const q=this.searchInput.value.trim().toLowerCase();
    if(!q)return list;
    const tags=q.split('#').map(s=>s.trim()).filter(Boolean);
    return list.filter(line=>tags.some(t=>line.toLowerCase().includes(t)));
  }

  showRandomImage(){
    const imgData=this.getRandomImageSource();if(!imgData)return;
    const test=new Image();
    test.onload=()=>{
      if(test.naturalWidth>=200&&test.naturalHeight>=200){
        this.imgElement.src=imgData.url;this.currentImage=imgData;this.resetImagePosition();
      }else this.showRandomImage();
    };
    test.onerror=()=>this.showRandomImage();
    test.src=imgData.url;
  }

  navigateForward(){this.showRandomImage();}
  navigateBack(){this.showRandomImage();}
}

function createInstances(count){
  document.getElementById('instancesContainer').innerHTML='';
  instances=[];
  for(let i=1;i<=count;i++){instances.push(new ImageInstance(i,hotkeys[i]));}
}

document.getElementById('instanceCount').addEventListener('change',e=>{
  createInstances(+e.target.value);
});

document.addEventListener('keydown',e=>{
  const key=e.key.toLowerCase();
  if(key==='a')instances.forEach(i=>i.navigateBack());
  if(key==='d')instances.forEach(i=>i.navigateForward());
  instances.forEach(inst=>{
    if(key===inst.hotkeys.flip)inst.flipImage();
    if(key===inst.hotkeys.reset)inst.resetImagePosition();
  });
});

createInstances(1);
</script>
</body>
</html>
