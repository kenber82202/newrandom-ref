<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Multi Instance Image Navigator</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;height:100vh;overflow:hidden;}
  #topControls{position:fixed;top:5px;z-index:1000;display:flex;gap:10px;background:rgba(0,0,0,0.5);padding:5px 10px;border-radius:8px;}
  body.hide-ui #topControls,body.hide-ui .toggles,body.hide-ui .search-bar,body.hide-ui .controls{display:none;}
  #instancesContainer{margin-top:50px;width:100%;height:100%;display:flex;flex-direction:column;gap:5px;}
  .instance{position:relative;width:100%;flex:1;display:flex;flex-direction:column;}
  .image-wrapper{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;}
  .instance img{max-width:100%;max-height:100%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);object-fit:contain;border:2px solid #fff;border-radius:6px;}
  .nav-arrow{position:absolute;top:50%;transform:translateY(-50%);font-size:48px;color:white;opacity:.5;cursor:pointer;z-index:20;}
  .nav-arrow.left{left:10px;}
  .nav-arrow.right{right:10px;}
  .toggles,.search-bar,.controls{position:absolute;z-index:10;background:rgba(0,0,0,.5);padding:3px 5px;border-radius:4px;display:flex;gap:4px;flex-wrap:wrap;}
  .toggles{top:5px;left:50%;transform:translateX(-50%);}
  .search-bar{top:5px;left:5px;}
  .controls{bottom:5px;left:50%;transform:translateX(-50%);}
</style>
</head>
<body>

<div id="topControls">
  <label>Instances:
    <select id="instanceCount">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </label>
  <button id="hideUIBtn">Hide UI</button>
</div>

<div id="instancesContainer"></div>

<script>
const baseURL='https://f003.backblazeb2.com/file/linksref2/';
const IMAGE_EXT=/\.(jpg|jpeg|png|webp|gif|avif|bmp)$/i;

const BITMAP_CACHE=new Map();
const MAX_BITMAPS=16;

const categories=[
  {v:"People",l:"P"},{v:"pplus",l:"p"},{v:"Anime",l:"A"},
  {v:"angle",l:"a"},{v:"Figure",l:"F"},{v:"Style",l:"S"},
  {v:"XMaleAnatomy",l:"X"},{v:"Emotions",l:"E"},
  {v:"Background",l:"B"},{v:"Walk",l:"W"},
  {v:"screencap",l:"s"},{v:"Manga",l:"M"},
  {v:"moeManga",l:"m"},{v:"TestPanel",l:"T"}
];

let instances=[];

class ImageInstance{
  constructor(){
    this.history=[];
    this.future=[];
    this.preload=[];
    this.maxHistory=4;
    this.maxFuture=4;
    this.maxPreload=4;
    this.sourceLists={};
    this.build();
  }

  build(){
    this.el=document.createElement('div');
    this.el.className='instance';
    this.el.innerHTML=`
      <div class="search-bar"><input placeholder="Search (#tag)"></div>
      <div class="toggles">${categories.map(c=>`<label><input type="checkbox" value="${c.v}">${c.l}</label>`).join('')}</div>
      <div class="image-wrapper">
        <div class="nav-arrow left">&#10094;</div>
        <div class="nav-arrow right">&#10095;</div>
        <img decoding="async" draggable="false">
      </div>
      <div class="controls"><button>Reset</button></div>`;
    this.img=this.el.querySelector('img');
    this.search=this.el.querySelector('input');
    this.checks=this.el.querySelectorAll('input[type=checkbox]');
    this.el.querySelector('.left').onclick=()=>this.back();
    this.el.querySelector('.right').onclick=()=>this.forward();
    this.el.querySelector('button').onclick=()=>this.reset();

    this.checks.forEach(c=>c.onchange=()=>this.reload());
    this.search.oninput=()=>this.reload();
  }

  reset(){this.img.style.transform='translate(-50%,-50%)';}

  async fetchList(cat){
    try{
      const r=await fetch(`${baseURL}${cat}.txt`);
      return (await r.text()).split('\n').map(l=>l.trim()).filter(l=>IMAGE_EXT.test(l));
    }catch{return []}
  }

  async reload(){
    const sel=[...this.checks].filter(c=>c.checked).map(c=>c.value);
    if(!sel.length)return;
    const res=await Promise.all(sel.map(c=>this.fetchList(c)));
    this.sourceLists=Object.fromEntries(sel.map((c,i)=>[c,res[i]]));
    this.history=[];this.future=[];this.preload=[];
    this.forward(true);
  }

  pickRandom(){
    const k=Object.keys(this.sourceLists);
    if(!k.length)return null;
    const list=this.sourceLists[k[Math.random()*k.length|0]];
    return list[Math.random()*list.length|0];
  }

  async decode(url){
    if(BITMAP_CACHE.has(url))return;
    const blob=await fetch(url).then(r=>r.blob());
    const bmp=await createImageBitmap(blob);
    BITMAP_CACHE.set(url,bmp);
    if(BITMAP_CACHE.size>MAX_BITMAPS)
      BITMAP_CACHE.delete(BITMAP_CACHE.keys().next().value);
  }

  preloadNext(){
    const used=new Set([...this.history,this.img.dataset.src,...this.future,...this.preload]);
    while(this.preload.length<this.maxPreload){
      const u=this.pickRandom();
      if(!u||used.has(u))break;
      used.add(u);
      this.decode(u);
      this.preload.push(u);
    }
  }

  show(url){
    this.img.src=url;
    this.img.dataset.src=url;
    this.reset();
  }

  forward(force=false){
    if(!force && this.future.length){
      this.history.push(this.img.dataset.src);
      if(this.history.length>this.maxHistory)this.history.shift();
      this.show(this.future.shift());
      return;
    }
    if(this.img.dataset.src){
      this.history.push(this.img.dataset.src);
      if(this.history.length>this.maxHistory)this.history.shift();
    }
    const next=this.preload.shift()||this.pickRandom();
    if(next)this.show(next);
    this.future=[];
    this.preloadNext();
  }

  back(){
    if(!this.history.length)return;
    this.future.unshift(this.img.dataset.src);
    if(this.future.length>this.maxFuture)this.future.pop();
    this.show(this.history.pop());
  }
}

function createInstances(n){
  const c=document.getElementById('instancesContainer');
  c.innerHTML='';instances=[];
  for(let i=0;i<n;i++){
    const inst=new ImageInstance();
    instances.push(inst);
    c.appendChild(inst.el);
  }
}

document.getElementById('instanceCount').onchange=e=>createInstances(+e.target.value);
document.getElementById('hideUIBtn').onclick=()=>document.body.classList.toggle('hide-ui');
document.addEventListener('keydown',e=>{
  if(e.key==='a')instances.forEach(i=>i.back());
  if(e.key==='d')instances.forEach(i=>i.forward());
  if(e.key.toLowerCase()==='u')document.body.classList.toggle('hide-ui');
});

createInstances(1);
</script>
</body>
</html>
