<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Multi Instance Image Navigator</title>
<style>
  body {
    margin:0;background:#000;color:#fff;font-family:sans-serif;
    display:flex;flex-direction:column;align-items:center;height:100vh;overflow:hidden;
  }
  #topControls {
    position:fixed;top:5px;z-index:1000;display:flex;gap:10px;
    background:rgba(0,0,0,0.5);padding:5px 10px;border-radius:8px;
  }
  #instancesContainer {
    margin-top:50px;width:100%;height:100%;
    display:flex;flex-direction:column;gap:5px;
  }
  .row {
    display:flex;
    width:100%;
    gap:5px;
  }
  .instance {
    position:relative;width:100%;flex:1;display:flex;flex-direction:column;
  }
  .image-wrapper {
    flex:1;display:flex;align-items:center;justify-content:center;position:relative;
    overflow:hidden;
  }
  .instance img {
    max-width:100%;max-height:100%;
    position:absolute;top:50%;left:50%;
    transform:translate(-50%,-50%) scale(1);
    object-fit:contain;border:2px solid #fff;border-radius:6px;
    transition:transform 0.1s ease-out;user-select:none;
  }
  .toggles, .search-bar, .controls {
    position:absolute;z-index:10;background:rgba(0,0,0,0.5);
    padding:3px 5px;border-radius:4px;display:flex;gap:4px;flex-wrap:wrap;
  }
  .toggles {top:5px;left:50%;transform:translateX(-50%);}
  .search-bar {top:5px;left:5px;}
  .controls {bottom:5px;left:50%;transform:translateX(-50%);}
  .toggles label, .controls button {cursor:pointer;font-size:0.75em;white-space:nowrap;}
  input[type=checkbox]{transform:scale(0.9);}
</style>
</head>
<body>

<div id="topControls">
  <label>Instances:
    <select id="instanceCount">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </label>
  <label>
    <input type="checkbox" id="layoutToggle"> Custom Layout
  </label>
</div>

<div id="instancesContainer"></div>

<script>
const baseURL='https://f003.backblazeb2.com/file/links-ref/';
const hotkeys={1:{flip:'f',reset:'r'},2:{flip:'g',reset:'t'},3:{flip:'h',reset:'y'}};
let instances=[];

const categories=[
  {v:"People",l:"P"},{v:"Figure",l:"F"},{v:"PeoplePlus",l:"+"},
  {v:"Angles",l:"a"},{v:"Anime",l:"A"},{v:"Style",l:"S"},
  {v:"Places",l:"P"},{v:"Emotion",l:"E"},{v:"Walk",l:"W"},
  {v:"male-anatomy",l:"M"},{v:"Fujimoto",l:"F"},{v:"Gege",l:"G"},
  {v:"Urasawa",l:"U+"},{v:"Asano",l:"A"},{v:"Isayama",l:"I"}
];

class ImageInstance{
  constructor(id,hotkeys){
    this.id=id;this.hotkeys=hotkeys;this.scale=1;this.isFlipped=false;
    this.translate={x:0,y:0};this.sourceLists={};this.currentImage=null;
    this.createUI();
  }

  createUI(){
    this.el=document.createElement('div');
    this.el.className='instance';
    this.el.innerHTML=`
      <div class="search-bar"><input placeholder="Search (#tag)"></div>
      <div class="toggles">
        ${categories.map(c=>`<label><input type="checkbox" value="${c.v}">${c.l}</label>`).join('')}
      </div>
      <div class="image-wrapper"><img draggable="false"></div>
      <div class="controls">
        <button class="flipBtn">Flip (${this.hotkeys.flip.toUpperCase()})</button>
        <button class="resetBtn">Reset (${this.hotkeys.reset.toUpperCase()})</button>
      </div>`;
    this.imgElement=this.el.querySelector('img');
    this.searchInput=this.el.querySelector('input');
    this.checkboxes=this.el.querySelectorAll('input[type=checkbox]');
    this.flipBtn=this.el.querySelector('.flipBtn');
    this.resetBtn=this.el.querySelector('.resetBtn');

    this.flipBtn.addEventListener('click',()=>this.flipImage());
    this.resetBtn.addEventListener('click',()=>this.resetImagePosition());
    this.checkboxes.forEach(cb=>cb.addEventListener('change',()=>this.loadSelectedSources()));
    this.searchInput.addEventListener('input',()=>this.loadSelectedSources());
    this.addDragging();
  }

  addDragging(){
    let isDragging=false,start={x:0,y:0};
    this.imgElement.addEventListener('mousedown',e=>{e.preventDefault();isDragging=true;start={x:e.clientX,y:e.clientY}});
    document.addEventListener('mousemove',e=>{
      if(!isDragging)return;
      this.translate.x+=e.clientX-start.x;this.translate.y+=e.clientY-start.y;
      start={x:e.clientX,y:e.clientY};this.updateTransform();
    });
    document.addEventListener('mouseup',()=>{isDragging=false;});
  }

  updateTransform(){
    const flip=this.isFlipped?-1:1;
    this.imgElement.style.transform=
      `translate(calc(-50% + ${this.translate.x}px),calc(-50% + ${this.translate.y}px)) scale(${flip*this.scale},${this.scale})`;
  }

  resetImagePosition(){this.scale=1;this.isFlipped=false;this.translate={x:0,y:0};this.updateTransform();}
  flipImage(){this.isFlipped=!this.isFlipped;this.updateTransform();}
  async fetchLinksFor(subject){try{const r=await fetch(`${baseURL}${subject}.txt`);const t=await r.text();return t.trim().split('\n').filter(Boolean);}catch{return []}}
  async loadSelectedSources(){
    const sel=[...this.checkboxes].filter(c=>c.checked).map(c=>c.value);
    if(!sel.length)return;
    const results=await Promise.all(sel.map(s=>this.fetchLinksFor(s)));
    this.sourceLists=Object.fromEntries(sel.map((s,i)=>[s,results[i]]));
    this.showRandomImage();
  }
  filterBySearch(list){
    const q=this.searchInput.value.trim().toLowerCase();if(!q)return list;
    const tags=q.split('#').map(s=>s.trim()).filter(Boolean);
    return list.filter(line=>tags.some(t=>line.toLowerCase().includes(t)));
  }
  getRandomImageSource(){
    const keys=Object.keys(this.sourceLists);if(!keys.length)return null;
    const chosen=keys[Math.floor(Math.random()*keys.length)];
    const links=this.filterBySearch(this.sourceLists[chosen]);if(!links.length)return null;
    return {subject:chosen,url:links[Math.floor(Math.random()*links.length)]};
  }
  showRandomImage(){
    const imgData=this.getRandomImageSource();if(!imgData)return;
    const test=new Image();test.onload=()=>{
      if(test.naturalWidth>=200&&test.naturalHeight>=200){
        this.imgElement.src=imgData.url;this.currentImage=imgData;this.resetImagePosition();
      }else this.showRandomImage();
    };test.onerror=()=>this.showRandomImage();test.src=imgData.url;
  }
  navigateForward(){this.showRandomImage();}
  navigateBack(){this.showRandomImage();}
}

function createInstances(count){
  const c=document.getElementById('instancesContainer');
  c.innerHTML='';
  instances=[];
  for(let i=1;i<=count;i++)instances.push(new ImageInstance(i,hotkeys[i]));
  applyLayout();
}

function applyLayout(){
  const c=document.getElementById('instancesContainer');
  c.innerHTML='';
  const count=instances.length;
  const custom=document.getElementById('layoutToggle').checked;

  if(!custom || count===1){
    instances.forEach(i=>{i.el.style.flex='1';c.appendChild(i.el)});
    return;
  }

  if(count===2){
    instances[0].el.style.flex='0 0 66%';
    instances[1].el.style.flex='0 0 34%';
    c.append(instances[0].el,instances[1].el);
  }

  if(count===3){
    const top=document.createElement('div');
    top.style.flex='0 0 66%';
    top.appendChild(instances[0].el);

    const bottom=document.createElement('div');
    bottom.className='row';
    bottom.style.flex='0 0 34%';
    instances[1].el.style.flex='1';
    instances[2].el.style.flex='1';
    bottom.append(instances[1].el,instances[2].el);

    c.append(top,bottom);
  }
}

document.getElementById('instanceCount').addEventListener('change',e=>createInstances(+e.target.value));
document.getElementById('layoutToggle').addEventListener('change',applyLayout);

document.addEventListener('keydown',e=>{
  const key=e.key.toLowerCase();
  if(key==='a')instances.forEach(i=>i.navigateBack());
  if(key==='d')instances.forEach(i=>i.navigateForward());
  instances.forEach(inst=>{
    if(key===inst.hotkeys.flip)inst.flipImage();
    if(key===inst.hotkeys.reset)inst.resetImagePosition();
  });
});

createInstances(1);
</script>
</body>
</html>
