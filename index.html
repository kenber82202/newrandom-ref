<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Ref Navigator - Multi-Mode</title>
  <style>
    :root { --bg: #000; --ui-bg: rgba(20,20,20,0.95); --accent: #4a90e2; --focus-color: #ff9800; }
    body { margin: 0; background: var(--bg); color: #fff; font-family: system-ui, sans-serif; height: 100vh; width: 100vw; overflow: hidden; display: flex; }
    
    /* Layout Logic */
    .instance { position: relative; flex: 1; height: 100vh; border-right: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; }
    .instance.hidden { display: none; }
    .instance:last-child { border-right: none; }

    .viewport { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #050505; }
    .mainImage { max-width: 100%; max-height: 100%; object-fit: contain; will-change: transform; transition: opacity 0.2s; cursor: grab; }
    
    /* UI Layers */
    .ui-layer { position: absolute; z-index: 100; pointer-events: none; width: 100%; height: 100%; }
    .ui-layer > * { pointer-events: auto; }

    .top-bar { top: 10px; display: flex; justify-content: center; width: 100%; position: absolute; }
    .category-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; background: var(--ui-bg); padding: 5px; border-radius: 10px; border: 1px solid #333; max-width: 80%; }
    
    .cat-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #333; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold; color: #888; }
    .cat-btn input { display: none; }
    .cat-btn:has(input:checked) { background: var(--accent); color: #fff; }

    .loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--ui-bg); padding: 12px 24px; border-radius: 10px; border: 1px solid var(--accent); display: none; z-index: 1000; font-size: 12px; pointer-events: none; }

    /* Controls Bar */
    .bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: var(--ui-bg); padding: 8px 20px; border-radius: 20px; border: 1px solid #333; z-index: 1000; }
    .tool-btn { background: none; border: none; color: #aaa; font-size: 18px; cursor: pointer; transition: 0.2s; }
    .tool-btn.active { color: var(--accent); }

    /* Focus Toggle - High Visibility */
    .focus-toggle { 
        position: absolute; 
        top: 15px; 
        right: 15px; 
        background: #333; 
        color: #fff; 
        width: 36px; 
        height: 36px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        border: 2px solid transparent; 
        border-radius: 8px; 
        font-size: 18px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .focus-toggle.active { 
        background: var(--focus-color); 
        border-color: #fff;
    }

    .hidden-ui .ui-layer, .hidden-ui .bottom-bar { display: none !important; }
  </style>
</head>
<body class="single-mode">

<div class="instance" id="inst1">
    <div class="ui-layer">
        <div class="top-bar">
            <div class="category-container cat-wrapper"></div>
        </div>
        <div class="focus-toggle active" title="Hotkey Focus (Orange = ON)">üéØ</div>
    </div>
    <div class="viewport">
        <img class="mainImage" draggable="false" />
        <div class="loader">SNIPING...</div>
    </div>
</div>

<div class="instance hidden" id="inst2">
    <div class="ui-layer">
        <div class="top-bar">
            <div class="category-container cat-wrapper"></div>
        </div>
        <div class="focus-toggle active" title="Hotkey Focus (Orange = ON)">üéØ</div>
    </div>
    <div class="viewport">
        <img class="mainImage" draggable="false" />
        <div class="loader">SNIPING...</div>
    </div>
</div>

<div class="bottom-bar">
    <button id="toggleDual" class="tool-btn" title="Toggle Dual Mode">üë•</button>
    <button id="resetAll" class="tool-btn" title="Reset Transforms">‚Üª</button>
    <button id="uiBtn" class="tool-btn" title="Toggle UI">üëÅ</button>
</div>

<script>
  const baseURL = 'https://f003.backblazeb2.com/file/linksref2/';
  const categories = [
    {v:"People",l:"P"},{v:"pplus",l:"p"},{v:"Anime",l:"A"},{v:"angle",l:"a"},{v:"Figure",l:"F"},{v:"Style",l:"S"},
    {v:"XMaleAnatomy",l:"X"},{v:"Emotions",l:"E"},{v:"Background",l:"B"},{v:"Walk",l:"W"},{v:"screencap",l:"s"},{v:"Manga",l:"M"},
    {v:"moeManga",l:"m"},{v:"TestPanel",l:"T"}
  ];

  class RefInstance {
    constructor(containerId, defaultCatIndex) {
      this.container = document.getElementById(containerId);
      this.img = this.container.querySelector('.mainImage');
      this.catWrapper = this.container.querySelector('.cat-wrapper');
      this.loader = this.container.querySelector('.loader');
      this.focusBtn = this.container.querySelector('.focus-toggle');
      
      this.state = {
        history: [],
        index: -1,
        prefetched: null,
        transform: { x:0, y:0, scale:1, flipped:false },
        isDragging: false,
        dragStart: { x:0, y:0 },
        minSize: 250,
        hotkeysEnabled: true
      };

      this.init(defaultCatIndex);
    }

    init(defaultCatIndex) {
      categories.forEach((cat, idx) => {
        const label = document.createElement('label');
        label.className = 'cat-btn';
        label.innerHTML = `<input type="checkbox" value="${cat.v}" ${idx === defaultCatIndex ? 'checked' : ''}>${cat.l}`;
        this.catWrapper.appendChild(label);
      });

      this.focusBtn.onclick = () => {
        this.state.hotkeysEnabled = !this.state.hotkeysEnabled;
        this.focusBtn.classList.toggle('active', this.state.hotkeysEnabled);
      };

      this.bindMouse();
      this.catWrapper.onchange = () => {
        this.state.history = [];
        this.state.index = -1;
        this.navigateForward();
      };
    }

    async getFileSize(cat) {
      try {
        const resp = await fetch(baseURL + cat + '.txt', { method: 'HEAD' });
        return parseInt(resp.headers.get('content-length')) || 100000;
      } catch(e) { return 100000; }
    }

    async sniperFetch(retry = 0) {
      if (retry > 5) return null;
      const active = [...this.catWrapper.querySelectorAll('input:checked')].map(i => i.value);
      if (!active.length) return null;
      
      const cat = active[Math.floor(Math.random() * active.length)];
      const totalSize = await this.getFileSize(cat);
      const randomPos = Math.floor(Math.random() * (totalSize - 3000));
      
      try {
        const resp = await fetch(baseURL + cat + '.txt', {
          headers: { 'Range': `bytes=${randomPos}-${randomPos + 2500}` }
        });
        const chunk = await resp.text();
        const validLines = chunk.split('\n').slice(1, -1).filter(l => l.length > 10);
        if (!validLines.length) return this.sniperFetch(retry + 1);

        const url = validLines[Math.floor(Math.random() * validLines.length)].trim();
        const isGood = await this.validateSize(url);
        return isGood ? url : this.sniperFetch(retry + 1);
      } catch (e) { return this.sniperFetch(retry + 1); }
    }

    validateSize(url) {
      return new Promise(res => {
        const i = new Image();
        i.onload = () => res(i.naturalWidth >= this.state.minSize);
        i.onerror = () => res(false);
        i.src = url;
      });
    }

    async navigateForward() {
      this.loader.style.display = 'block';
      if (this.state.index < this.state.history.length - 1) {
        this.state.index++;
        this.displayImage(this.state.history[this.state.index]);
        return;
      }
      let url = this.state.prefetched || await this.sniperFetch();
      this.state.prefetched = null;
      if (url) {
        this.state.history.push(url);
        this.state.index = this.state.history.length - 1;
        this.displayImage(url);
      }
    }

    navigateBack() {
      if (this.state.index > 0) {
        this.state.index--;
        this.displayImage(this.state.history[this.state.index]);
      }
    }

    displayImage(url) {
      this.img.style.opacity = '0.3';
      this.loader.style.display = 'block';
      const temp = new Image();
      temp.onload = () => {
        this.img.src = url;
        this.img.style.opacity = '1';
        this.loader.style.display = 'none';
        this.resetTransform();
        this.prepareNext();
      };
      temp.src = url;
    }

    async prepareNext() { this.state.prefetched = await this.sniperFetch(); }

    applyTransform() {
      const {x, y, scale, flipped} = this.state.transform;
      this.img.style.transform = `translate(${x}px, ${y}px) scale(${scale * (flipped ? -1 : 1)}, ${scale})`;
    }

    resetTransform() {
      this.state.transform = { x:0, y:0, scale:1, flipped:false };
      this.applyTransform();
    }

    bindMouse() {
      const start = (x, y) => { this.state.isDragging = true; this.state.dragStart = { x: x - this.state.transform.x, y: y - this.state.transform.y }; };
      const move = (x, y) => { if (this.state.isDragging) { this.state.transform.x = x - this.state.dragStart.x; this.state.transform.y = y - this.state.dragStart.y; this.applyTransform(); } };
      this.img.onmousedown = e => start(e.clientX, e.clientY);
      this.container.onmousemove = e => move(e.clientX, e.clientY);
      window.addEventListener('mouseup', () => this.state.isDragging = false);
    }
  }

  // Init
  const instances = [ new RefInstance('inst1', 0), new RefInstance('inst2', 2) ];
  instances[0].navigateForward();

  // Mode Toggling
  const dualBtn = document.getElementById('toggleDual');
  let isDual = false;

  dualBtn.onclick = () => {
    isDual = !isDual;
    dualBtn.classList.toggle('active', isDual);
    document.getElementById('inst2').classList.toggle('hidden', !isDual);
    if (isDual && instances[1].state.index === -1) {
        instances[1].navigateForward();
    }
  };

  // Global UI buttons
  document.getElementById('resetAll').onclick = () => instances.forEach(i => i.resetTransform());
  document.getElementById('uiBtn').onclick = () => document.body.classList.toggle('hidden-ui');

  // Unified Hotkeys
  document.onkeydown = (e) => {
    const k = e.key.toLowerCase();
    instances.forEach((inst, idx) => {
        const isVisible = idx === 0 || isDual;
        if (isVisible && inst.state.hotkeysEnabled) {
            if (k === 'd' || k === 'arrowright') inst.navigateForward();
            if (k === 'a' || k === 'arrowleft') inst.navigateBack();
            if (k === 'w') { inst.state.transform.scale += 0.2; inst.applyTransform(); }
            if (k === 's') { inst.state.transform.scale = Math.max(0.1, inst.state.transform.scale - 0.2); inst.applyTransform(); }
            if (k === 'f') { inst.state.transform.flipped = !inst.state.transform.flipped; inst.applyTransform(); }
            if (k === 'r') inst.resetTransform();
        }
    });
    if (k === 'u') document.body.classList.toggle('hidden-ui');
  };
</script>
</body>
</html>
