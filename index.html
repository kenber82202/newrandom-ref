<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Multi Instance Image Navigator</title>
<style>
  body {
    margin:0;background:#000;color:#fff;font-family:sans-serif;
    display:flex;flex-direction:column;align-items:center;height:100vh;overflow:hidden;
  }
  #topControls {
    position:fixed;top:5px;z-index:1000;display:flex;gap:10px;
    background:rgba(0,0,0,0.5);padding:5px 10px;border-radius:8px;
  }
  body.hide-ui #topControls,
  body.hide-ui .toggles,
  body.hide-ui .search-bar,
  body.hide-ui .controls {
    display:none;
  }

  #instancesContainer {
    margin-top:50px;width:100%;height:100%;
    display:flex;flex-direction:column;gap:5px;
  }
  .row{display:flex;width:100%;gap:5px;}
  .instance{
    position:relative;width:100%;flex:1;display:flex;flex-direction:column;
  }
  .image-wrapper{
    flex:1;display:flex;align-items:center;justify-content:center;
    position:relative;overflow:hidden;
  }
  .instance img{
    max-width:100%;max-height:100%;
    position:absolute;top:50%;left:50%;
    transform:translate(-50%,-50%) scale(1);
    object-fit:contain;border:2px solid #fff;border-radius:6px;
    transition:transform 0.1s ease-out;user-select:none;
  }

  .nav-arrow{
    position:absolute;top:50%;
    transform:translateY(-50%);
    font-size:48px;
    color:white;
    opacity:0.5;
    cursor:pointer;
    user-select:none;
    z-index:20;
  }
  .nav-arrow.left{left:10px;}
  .nav-arrow.right{right:10px;}

  .toggles,.search-bar,.controls{
    position:absolute;z-index:10;background:rgba(0,0,0,0.5);
    padding:3px 5px;border-radius:4px;display:flex;gap:4px;flex-wrap:wrap;
  }
  .toggles{top:5px;left:50%;transform:translateX(-50%);}
  .search-bar{top:5px;left:5px;}
  .controls{bottom:5px;left:50%;transform:translateX(-50%);}
</style>
</head>
<body>

<div id="topControls">
  <label>Instances:
    <select id="instanceCount">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </label>
  <label><input type="checkbox" id="layoutToggle"> Custom Layout</label>
  <button id="hideUIBtn">Hide UI</button>
</div>

<div id="instancesContainer"></div>

<script>
const baseURL='https://f003.backblazeb2.com/file/links-ref/';
const hotkeys={1:{flip:'f',reset:'r'},2:{flip:'g',reset:'t'},3:{flip:'h',reset:'y'}};
let instances=[];

const categories=[
  {v:"People",l:"P"},{v:"Figure",l:"F"},{v:"PeoplePlus",l:"+"},
  {v:"Angles",l:"a"},{v:"Anime",l:"A"},{v:"Style",l:"S"},
  {v:"Places",l:"P"},{v:"Emotion",l:"E"},{v:"Walk",l:"W"},
  {v:"male-anatomy",l:"M"},{v:"Fujimoto",l:"F"},{v:"Gege",l:"G"},
  {v:"Urasawa",l:"U+"},{v:"Asano",l:"A"},{v:"Isayama",l:"I"}
];

class ImageInstance{
  constructor(id,hotkeys){
    this.id=id;this.hotkeys=hotkeys;
    this.scale=1;this.isFlipped=false;this.translate={x:0,y:0};
    this.sourceLists={};

    this.history=[];this.future=[];this.preloadQueue=[];
    this.maxHistory=4;this.maxPreload=8;

    this.createUI();
  }

  createUI(){
    this.el=document.createElement('div');
    this.el.className='instance';
    this.el.innerHTML=`
      <div class="search-bar"><input placeholder="Search (#tag)"></div>
      <div class="toggles">
        ${categories.map(c=>`<label><input type="checkbox" value="${c.v}">${c.l}</label>`).join('')}
      </div>
      <div class="image-wrapper">
        <div class="nav-arrow left">&#10094;</div>
        <div class="nav-arrow right">&#10095;</div>
        <img draggable="false">
      </div>
      <div class="controls">
        <button class="flipBtn">Flip</button>
        <button class="resetBtn">Reset</button>
      </div>`;

    this.img=this.el.querySelector('img');
    this.el.querySelector('.left').onclick=()=>this.back();
    this.el.querySelector('.right').onclick=()=>this.forward();
    this.el.querySelector('.flipBtn').onclick=()=>this.flip();
    this.el.querySelector('.resetBtn').onclick=()=>this.reset();

    this.search=this.el.querySelector('input');
    this.checks=this.el.querySelectorAll('input[type=checkbox]');
    this.checks.forEach(c=>c.onchange=()=>this.reloadSources());
    this.search.oninput=()=>this.reloadSources();

    this.drag();
  }

  drag(){
    let d=false,s={x:0,y:0};
    this.img.onmousedown=e=>{d=true;s={x:e.clientX,y:e.clientY}};
    document.onmousemove=e=>{
      if(!d)return;
      this.translate.x+=e.clientX-s.x;
      this.translate.y+=e.clientY-s.y;
      s={x:e.clientX,y:e.clientY};
      this.apply();
    };
    document.onmouseup=()=>d=false;
  }

  apply(){
    const f=this.isFlipped?-1:1;
    this.img.style.transform=
      `translate(calc(-50% + ${this.translate.x}px),calc(-50% + ${this.translate.y}px)) scale(${f*this.scale},${this.scale})`;
  }

  reset(){this.scale=1;this.isFlipped=false;this.translate={x:0,y:0};this.apply();}
  flip(){this.isFlipped=!this.isFlipped;this.apply();}

  async fetchLinks(s){
    try{const r=await fetch(`${baseURL}${s}.txt`);
      return (await r.text()).split('\n').filter(Boolean);}catch{return []}
  }

  async reloadSources(){
    const sel=[...this.checks].filter(c=>c.checked).map(c=>c.value);
    if(!sel.length)return;
    const res=await Promise.all(sel.map(s=>this.fetchLinks(s)));
    this.sourceLists=Object.fromEntries(sel.map((s,i)=>[s,res[i]]));
    this.history=[];this.future=[];this.preloadQueue=[];
    this.forward();
  }

  randomSource(){
    const k=Object.keys(this.sourceLists);
    if(!k.length)return null;
    const s=k[Math.floor(Math.random()*k.length)];
    const l=this.sourceLists[s];
    return l[Math.floor(Math.random()*l.length)];
  }

  preload(){
    while(this.preloadQueue.length<this.maxPreload){
      const u=this.randomSource();
      if(!u)break;
      const img=new Image();img.src=u;
      this.preloadQueue.push(u);
    }
  }

  show(url){this.img.src=url;this.reset();}

  forward(){
    if(this.img.src)this.history.push(this.img.src);
    if(this.history.length>this.maxHistory)this.history.shift();
    const next=this.future.shift()||this.preloadQueue.shift()||this.randomSource();
    if(next)this.show(next);
    this.future=[];
    this.preload();
  }

  back(){
    if(!this.history.length)return;
    this.future.unshift(this.img.src);
    this.show(this.history.pop());
  }
}

function createInstances(n){
  const c=document.getElementById('instancesContainer');
  c.innerHTML='';instances=[];
  for(let i=1;i<=n;i++)instances.push(new ImageInstance(i,hotkeys[i]));
  applyLayout();
}

function applyLayout(){
  const c=document.getElementById('instancesContainer');
  c.innerHTML='';
  const n=instances.length;
  const on=document.getElementById('layoutToggle').checked;

  if(!on||n===1){instances.forEach(i=>c.appendChild(i.el));return;}
  if(n===2){
    instances[0].el.style.flex='0 0 66%';
    instances[1].el.style.flex='0 0 34%';
    c.append(instances[0].el,instances[1].el);
  }
  if(n===3){
    const t=document.createElement('div');t.style.flex='0 0 66%';
    const b=document.createElement('div');b.className='row';b.style.flex='0 0 34%';
    t.append(instances[0].el);
    b.append(instances[1].el,instances[2].el);
    c.append(t,b);
  }
}

document.getElementById('instanceCount').onchange=e=>createInstances(+e.target.value);
document.getElementById('layoutToggle').onchange=applyLayout;
document.getElementById('hideUIBtn').onclick=()=>document.body.classList.toggle('hide-ui');

document.addEventListener('keydown',e=>{
  if(e.key.toLowerCase()==='u')document.body.classList.toggle('hide-ui');
  if(e.key==='a')instances.forEach(i=>i.back());
  if(e.key==='d')instances.forEach(i=>i.forward());
});

createInstances(1);
</script>
</body>
</html>
